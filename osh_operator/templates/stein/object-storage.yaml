#apiVersion: lcm.mirantis.com/v1alpha1
#kind: HelmBundle

spec:
  releases:
  - name: openstack-ceph-rgw
    chart: {{spec.common.infra.repo}}/ceph-rgw
    values:
      images:
        tags:
{%- for image in [
    "ks_service",
    "image_repo_sync",
    "rgw_s3_admin",
    "ceph_config_helper",
    "ks_endpoints",
    "dep_check",
    "ceph_rgw",
    "ks_user",] %}
        {%- if image in images %}
          {{ image }}: {{ images[image] }}
        {%- endif %}
{%- endfor %}
      conf:
        rgw_ks:
          enabled: true
      # We setup rgw by rook, this is needed only to create resources in keystone
      manifests:
        configmap_ceph_templates: true
        configmap_bin: false
        configmap_bin_ks: true
        configmap_test_bin: false
        configmap_etc: false
        deployment_rgw: false
        ingress_rgw: false
        job_ceph_rgw_storage_init: false
        job_image_repo_sync: false
        job_ks_endpoints: true
        job_ks_service: true
        job_ks_user: true
        job_s3_admin: true
        secret_s3_rgw: false
        secret_keystone_rgw: true
        secret_ingress_tls: false
        secret_keystone: true
        service_ingress_rgw: false
        service_rgw: false
        helm_tests: false
        network_policy: false
      endpoints:
        cluster_domain_suffix: {{ spec.domain_name }}
        identity:
          auth:
            admin:
              region_name: {{ spec.features.keystone.get('users', {}).get('admin', {}).get('region_name', 'RegionOne') }}
              username: {{ admin_creds.identity.username }}
              password: {{ admin_creds.identity.password }}
              project_name: {{ spec.features.keystone.get('users', {}).get('admin', {}).get('project_name', 'admin') }}
              user_domain_name: {{ spec.features.keystone.get('users', {}).get('admin', {}).get('user_domain_name', 'default') }}
              project_domain_name: {{ spec.features.keystone.get('users', {}).get('admin', {}).get('project_domain_name', 'default') }}
              default_domain_id: {{ spec.features.keystone.get('users', {}).get('admin', {}).get('default_domain_id', 'default') }}
            # TODO: make username/password autogenerated
            swift:
              role: admin
              region_name: RegionOne
              username: swift
              password: password
              project_name: service
              user_domain_name: service
              project_domain_name: service
              os_auth_type: password
              os_tenant_name: admin
          # TODO(vsaienko): the link to rgw will be provided by rook.
          object_store:
              name: swift
              namespace: null
              hosts:
                default: ceph-rgw
                public: radosgw
              host_fqdn_override:
                default: null
                # NOTE(portdirect): this chart supports TLS for fqdn over-ridden public
                # endpoints using the following format:
                # public:
                #   host: null
                #   tls:
                #     crt: null
                #     key: null
              path:
                default: /swift/v1/KEY_$(tenant_id)s
              scheme:
                default: http
              port:
                api:
                  default: 8088
                  public: 80
