apiVersion: lcm.mirantis.com/v1alpha1
kind: HelmBundle
metadata:
  name: openstack-dashboard
spec:
  releases:
  - name: openstack-horizon
    chart: {{spec.common.openstack.repo}}/horizon
    values:
      dependencies:
        static:
          db_init:
            jobs:
              - openstack-mariadb-cluster-wait
      manifests:
        network_policy: false
      endpoints:
        cluster_domain_suffix: {{ spec.domain_name }}
{%- if spec.get('features', {}).get('keystone', {}).get('keycloak', {}).get('enabled', False) %}
        identity:
          hosts:
            internal: keystone
          path:
            default: /v3
          port:
            api:
              internal: 80
{%- endif %}
{%- if spec.get('features', {}).get('ssl', {}).get('public_endpoints', {}).get('enabled', True) %}
        dashboard:
          host_fqdn_override:
            public:
              tls:
                ca: |
{{ spec.features.ssl.public_endpoints.ca_cert | indent( width=18, indentfirst=True) }}
                crt: |
{{ spec.features.ssl.public_endpoints.api_cert | indent( width=18, indentfirst=True) }}
                key: |
{{ spec.features.ssl.public_endpoints.api_key | indent( width=18, indentfirst=True) }}
          hosts:
            default: horizon-int
            public:
              host: horizon
              tls:
                ca: |
{{ spec.features.ssl.public_endpoints.ca_cert | indent( width=18, indentfirst=True) }}
                crt: |
{{ spec.features.ssl.public_endpoints.api_cert | indent( width=18, indentfirst=True) }}
                key: |
{{ spec.features.ssl.public_endpoints.api_key | indent( width=18, indentfirst=True) }}
{%- endif %}
{%- if spec.get('features', {}).get('keystone', {}).get('keycloak', {}).get('enabled', False) or spec.get('features', {}).get('ssl', {}).get('public_endpoints', {}).get('enabled', True) %}
      conf:
        horizon:
          local_settings:
            config:
              horizon_images_upload_mode: 'direct'
{%- if spec.get('features', {}).get('keystone', {}).get('keycloak', {}).get('enabled', False) %}
              auth:
                idp_mapping:
                - idp: keycloak
                  label: External Authentication Service
                  name: mapped
                  protocol: mapped
                sso:
                  enabled: true
                  initial_choice: mapped
{%- endif %}
{%- if spec.get('features', {}).get('ssl', {}).get('public_endpoints', {}).get('enabled', True) %}
              secure_proxy_ssl_header: true
              ssl_features:
                openstack_ssl_cacert:
                  enabled: True
{%- endif %}
{%- endif %}
