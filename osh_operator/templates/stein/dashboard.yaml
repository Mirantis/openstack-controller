{%- set keystone_keycloak_enabled = spec.get('features', {}).get('keystone', {}).get('keycloak', {}).get('enabled', False) %}
{%- set ssl_public_endpoints_enabled = spec.get('features', {}).get('ssl', {}).get('public_endpoints', {}).get('enabled', True) %}
#The list of extra panels in Horizon helm-chart is overwritten in case 'extra_panels' is defined in osh-operator.
{%- set horizon_extra_panels = ['neutron_taas_dashboard', 'heat_dashboard'] %}
{%- if 'load-balancer' in spec.features.services %}
  {%- do horizon_extra_panels.append('octavia_dashboard') %}
{%- endif %}

apiVersion: lcm.mirantis.com/v1alpha1
kind: HelmBundle
metadata:
  name: openstack-dashboard
spec:
  releases:
  - name: openstack-horizon
    chart: {{spec.common.openstack.repo}}/horizon
    values:
      dependencies:
        static:
          db_init:
            jobs:
              - openstack-mariadb-cluster-wait
      manifests:
        network_policy: false
{%- if ssl_public_endpoints_enabled %}
        secret_ca_bundle: true
{%- endif %}
      endpoints:
        cluster_domain_suffix: {{ spec.domain_name }}
{%- if keystone_keycloak_enabled %}
        identity:
          hosts:
            internal: keystone
          path:
            default: /v3
          port:
            api:
              internal: 80
{%- endif %}
{%- if ssl_public_endpoints_enabled %}
        dashboard:
          host_fqdn_override:
            public:
              tls:
                ca: |
{{ spec.features.ssl.public_endpoints.ca_cert | indent( width=18, indentfirst=True) }}
                crt: |
{{ spec.features.ssl.public_endpoints.api_cert | indent( width=18, indentfirst=True) }}
                key: |
{{ spec.features.ssl.public_endpoints.api_key | indent( width=18, indentfirst=True) }}
          hosts:
            default: horizon-int
            public:
              host: horizon
              tls:
                ca: |
{{ spec.features.ssl.public_endpoints.ca_cert | indent( width=18, indentfirst=True) }}
                crt: |
{{ spec.features.ssl.public_endpoints.api_cert | indent( width=18, indentfirst=True) }}
                key: |
{{ spec.features.ssl.public_endpoints.api_key | indent( width=18, indentfirst=True) }}
{%- endif %}
      conf:
        horizon:
          extra_panels: {{ horizon_extra_panels }}
          local_settings:
            config:
              horizon_images_upload_mode: 'direct'
{%- if keystone_keycloak_enabled %}
              auth:
                idp_mapping:
                - idp: keycloak
                  label: External Authentication Service
                  name: mapped
                  protocol: mapped
                sso:
                  enabled: true
                  initial_choice: mapped
{%- endif %}
{%- if ssl_public_endpoints_enabled %}
              secure_proxy_ssl_header: true
              ssl_features:
                openstack_ssl_cacert:
                  enabled: True
{%- endif %}
