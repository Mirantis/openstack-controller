---
apiVersion: v1
kind: ServiceAccount
metadata:
  namespace: osh-system
  name: openstack-controller-account
---
apiVersion: rbac.authorization.k8s.io/v1beta1
kind: ClusterRole
metadata:
  name: openstack-controller-role-cluster
rules:

  # NOTE(pas-ha) needed for multi-instance, including dev override
  # Framework: knowing which other operators are running (i.e. peering).
  - apiGroups: [apiextensions.k8s.io]
    resources: [customresourcedefinitions]
    verbs: [list, get]
  - apiGroups: [zalando.org]
    resources: [clusterkopfpeerings]
    verbs: [list, get, watch, patch]

  # Application: read-only access for watching cluster-wide.
  - apiGroups: [lcm.mirantis.com]
    resources: [openstackdeployments]
    verbs: [list, get, watch]
  - apiGroups: [lcm.mirantis.com]
    resources: [helmbundles]
    verbs: [list, get, watch]
---
apiVersion: rbac.authorization.k8s.io/v1beta1
kind: Role
metadata:
  namespace: "{{ .Values.osdpl.namespace }}"
  name: "openstack-controller-role-{{ .Values.osdpl.namespace }}"
rules:

  # Framework: posting the events about the handlers progress/errors.
  - apiGroups: [""]
    resources: [events]
    verbs: [create]
  # Application: read secret with keystone creds
  - apiGroups: [""]
    resources: [secrets]
    verbs: [list, get, watch, patch]
  # NOTE(pas-ha) needed for multi-instance, including dev override
  # Framework: knowing which other operators are running (i.e. peering).
  - apiGroups: [zalando.org]
    resources: [kopfpeerings]
    verbs: [list, get, watch, patch]

  # Application: manage ceph access data(secrets,configmaps)
  - apiGroups: [""]
    resources: [secrets,configmaps]
    verbs: [list, get, create]

  # Application: watching & handling for the custom resource we declare.
  - apiGroups: [lcm.mirantis.com]
    resources: [openstackdeployments]
    verbs: [list, get, watch, patch]

  # Application: resources we produce and manipulate.
  - apiGroups: [lcm.mirantis.com]
    resources: [helmbundles]
    verbs: [list, get, watch, create, update, patch, delete]

  # Manage child resources
  - apiGroups: [extensions, apps, batch]
    resources: [deployments, statefulsets, daemonsets, jobs]
    verbs: [list, get, create, watch, patch, delete]
---
apiVersion: rbac.authorization.k8s.io/v1beta1
kind: Role
metadata:
  namespace: {{ .Values.osdpl.cephSharedNamespace }}
  name: "openstack-controller-role-{{ .Values.osdpl.cephSharedNamespace }}"
rules:

  # Application: read ceph access data from shared namespace.
  - apiGroups: [""]
    resources: [secrets,configmaps]
    verbs: [list, get, create, patch, update]
---
apiVersion: rbac.authorization.k8s.io/v1beta1
kind: ClusterRoleBinding
metadata:
  name: openstack-controller-rolebinding-cluster
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: openstack-controller-role-cluster
subjects:
  - kind: ServiceAccount
    name: openstack-controller-account
    namespace: osh-system
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  labels:
  name: openstack-controller-account:cluster-admin
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: cluster-admin
subjects:
- kind: ServiceAccount
  name: openstack-controller-account
  namespace: osh-system
---
apiVersion: rbac.authorization.k8s.io/v1beta1
kind: RoleBinding
metadata:
  namespace: "{{ .Values.osdpl.namespace }}"
  name: "openstack-controller-rolebinding-{{ .Values.osdpl.namespace }}"
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: "openstack-controller-role-{{ .Values.osdpl.namespace }}"
subjects:
  - kind: ServiceAccount
    name: openstack-controller-account
    namespace: osh-system
---
apiVersion: rbac.authorization.k8s.io/v1beta1
kind: RoleBinding
metadata:
  namespace: {{ .Values.osdpl.cephSharedNamespace }}
  name: "openstack-controller-rolebinding-{{ .Values.osdpl.cephSharedNamespace }}"
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: "openstack-controller-role-{{ .Values.osdpl.cephSharedNamespace }}"
subjects:
  - kind: ServiceAccount
    name: openstack-controller-account
    namespace: osh-system
---
apiVersion: zalando.org/v1
kind: KopfPeering
metadata:
  namespace: "{{ .Values.osdpl.namespace }}"
  name: openstack-controller.osdpl
---
apiVersion: zalando.org/v1
kind: KopfPeering
metadata:
  namespace: "{{ .Values.osdpl.namespace }}"
  name: openstack-controller.helmbundle
---
apiVersion: zalando.org/v1
kind: KopfPeering
metadata:
  namespace: "{{ .Values.osdpl.namespace }}"
  name: openstack-controller.secrets
---
apiVersion: zalando.org/v1
kind: KopfPeering
metadata:
  namespace: "{{ .Values.osdpl.namespace }}"
  name: openstack-controller.health
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "openstack-controller.fullname" . }}
  namespace: osh-system
  labels:
    app.kubernetes.io/name: {{ include "openstack-controller.name" . }}
    helm.sh/chart: {{ include "openstack-controller.chart" . }}
    app.kubernetes.io/instance: {{ .Release.Name }}
    app.kubernetes.io/managed-by: {{ .Release.Service }}
spec:
  replicas: {{ .Values.replicaCount }}
  selector:
    matchLabels:
      app.kubernetes.io/name: {{ include "openstack-controller.name" . }}
      app.kubernetes.io/instance: {{ .Release.Name }}
  template:
    metadata:
      labels:
        app.kubernetes.io/name: {{ include "openstack-controller.name" . }}
        app.kubernetes.io/instance: {{ .Release.Name }}
    spec:
      serviceAccountName: openstack-controller-account
      containers:
        - name: osdpl
          image: {{ tuple . .Values.image | include "getImageUrl" }}
          imagePullPolicy: {{ .Values.image.pullPolicy }}
          command:
            - kopf
            - run
            - '-n'
            - {{ .Values.osdpl.namespace }}
            - '-P'
            - openstack-controller.osdpl
            - '-m'
            - openstack_controller.controllers.openstackdeployment
            - '-m'
            - openstack_controller.controllers.probe
            - '-L'
            - 'http://0.0.0.0:44090/healthz'
          livenessProbe:
            httpGet:
              path: /healthz
              port: 44090
            periodSeconds: 120
          resources:
            {{- toYaml .Values.resources | nindent 12 }}
        - name: helmbundle
          image: {{ tuple . .Values.image | include "getImageUrl" }}
          imagePullPolicy: {{ .Values.image.pullPolicy }}
          command:
            - kopf
            - run
            - '-n'
            - {{ .Values.osdpl.namespace }}
            - '-P'
            - openstack-controller.helmbundle
            - '-m'
            - openstack_controller.controllers.helmbundle
            - '-m'
            - openstack_controller.controllers.probe
            - '-L'
            - 'http://0.0.0.0:44091/healthz'
          livenessProbe:
            httpGet:
              path: /healthz
              port: 44091
            periodSeconds: 120
          resources:
            {{- toYaml .Values.resources | nindent 12 }}
        - name: secrets
          image: {{ tuple . .Values.image | include "getImageUrl" }}
          imagePullPolicy: {{ .Values.image.pullPolicy }}
          command:
            - kopf
            - run
            - '-n'
            - {{ .Values.osdpl.namespace }}
            - '-P'
            - openstack-controller.secrets
            - '-m'
            - openstack_controller.controllers.secrets
            - '-m'
            - openstack_controller.controllers.probe
            - '-L'
            - 'http://0.0.0.0:44092/healthz'
          livenessProbe:
            httpGet:
              path: /healthz
              port: 44092
            periodSeconds: 120
          resources:
            {{- toYaml .Values.resources | nindent 12 }}
        - name: health
          image: {{ tuple . .Values.image | include "getImageUrl" }}
          imagePullPolicy: {{ .Values.image.pullPolicy }}
          command:
            - kopf
            - run
            - '-n'
            - {{ .Values.osdpl.namespace }}
            - '-P'
            - openstack-controller.health
            - '-m'
            - openstack_controller.controllers.health
            - '-m'
            - openstack_controller.controllers.probe
            - '-L'
            - 'http://0.0.0.0:44093/healthz'
          livenessProbe:
            httpGet:
              path: /healthz
              port: 44093
            periodSeconds: 120
          resources:
            {{- toYaml .Values.resources | nindent 12 }}
      {{- with .Values.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
    {{- with .Values.affinity }}
      affinity:
        {{- toYaml . | nindent 8 }}
    {{- end }}
    {{- with .Values.tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
    {{- end }}
