[tox]
minversion = 2.0
skipdist = True
envlist = pep8,tests

[testenv]
basepython = python3.7
usedevelop = True
install_command = {toxinidir}/tox_install.sh -U {opts} {packages}
deps =
    .[test]
    -r{toxinidir}/requirements.txt
    -r{toxinidir}/test-requirements.txt
setenv =
    OSH_OPERATOR_BASE_PATH = {toxinidir}

[testenv:pep8]
# using black for code style, so ignore pycodestyle violations from flake8
commands =
    flake8 osh_operator tests
    black --check --diff osh_operator tests

[testenv:black]
envdir={toxworkdir}/pep8
# actually format code with black
# run flake8 just in case afterwards
commands =
    black osh_operator tests
    flake8 --extend-ignore E,W osh_operator

[testenv:tests]
deps =
    {[testenv]deps}
    pytest
commands =
    pytest tests {posargs}

[testenv:dev]
deps =
    {[testenv]deps}
    ipython
    ipdb
passenv = KOPF_RUN_DEBUG
whitelist_externals = find
commands =
    find {toxinidir}/osh_operator -type f -name '*.pyc' -delete
    kopf run --dev -m osh_operator.openstackdeployment -m osh_operator.helmbundle -m osh_operator.secrets -n openstack

[flake8]
extend-ignore = E,W
