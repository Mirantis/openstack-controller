[tox]
minversion = 2.0
skipdist = True
envlist = pep8,py37

[testenv]
basepython = python3.7
usedevelop = True
install_command = {toxinidir}/tox_install.sh {opts} {packages}
deps =
    .[test]
commands =
    pytest tests {posargs}

[testenv:pep8]
# using black for code style, so ignore pycodestyle violations from flake8
commands =
    flake8 osh_operator tests
    black --check --diff osh_operator tests

[testenv:black]
envdir={toxworkdir}/pep8
# actually format code with black
# run flake8 just in case afterwards
commands =
    black osh_operator tests
    flake8 --extend-ignore E,W osh_operator

[testenv:docs]
envdir = {toxworkdir}/docs
deps =
    -r{toxinidir}/docs/requirements.txt
commands = sphinx-build -b html -W docs/source docs/build/html

[testenv:releasenotes]
envdir = {toxworkdir}/docs
deps =
  -r{toxinidir}/docs/requirements.txt
commands =
  sphinx-build -a -E -W -d releasenotes/build/doctrees -b html releasenotes/source releasenotes/build/html

[testenv:dev]
deps =
    {[testenv]deps}
    ipdb
passenv = KOPF_RUN_DEBUG
whitelist_externals = find
# use new py37 'breakpoint()' built-in, IPython will be used
setenv =
    PYTHONBREAKPOINT=ipdb.set_trace
commands =
    find {toxinidir}/osh_operator -type f -name '*.pyc' -delete
    kopf run --dev -m osh_operator.openstackdeployment -m osh_operator.helmbundle -m osh_operator.secrets -n openstack

[flake8]
extend-ignore = E,W
