#apiVersion: lcm.mirantis.com/v1alpha1
#kind: HelmBundle

{%- set service = 'tempest' %}
{%- set signature = spec.get('features', {}).get('glance', {}).get("signature", {"enabled": false}) %}

spec:
  releases:
  - name: openstack-tempest
    chart: {{spec.common.openstack.repo}}/tempest
    values:
      images:
        tags:
{%- for image in [
    "tempest_run_tests",
    "ks_user",
    "dep_check",
    "image_repo_sync",
    "bootstrap",
    "tempest_static_accounts",
    "tempest-uuids-init",] %}
        {%- if image in images %}
          {{ image }}: {{ images[image] }}
        {%- endif %}
{%- endfor %}
      manifests:
        network_policy: false
        secret_ca_bundle: true
{%- if signature.enabled %}
        job_static_accounts: true
{%- endif %}
      pod:
        replicas:
          server: 1
      pvc:
        storage_class: {{ spec.get('persistent_volume_storage_class', 'default') }}
      endpoints:
        cluster_domain_suffix: {{ spec.internal_domain_name }}
{% include 'base/_admin_identity.yaml' %}
          host_fqdn_override:
            public:
              host: keystone.{{ spec.public_domain_name }}
              tls:
                ca: |
{{ spec.features.ssl.public_endpoints.ca_cert | indent( width=18, first=True) }}
{%- if rgw_internal_cacert is defined %}
{{ rgw_internal_cacert | indent( width=18, first=True) }}
{%- endif %}
{%- if proxy_settings is defined %}
{%- if proxy_settings.get("proxy_ca_certificate") %}
{{ proxy_settings["proxy_ca_certificate"] | indent( width=18, first=True) }}
{%- endif %}
{%- endif %}
                crt: |
{{ spec.features.ssl.public_endpoints.api_cert | indent( width=18, first=True) }}
                key: |
{{ spec.features.ssl.public_endpoints.api_key | indent( width=18, first=True) }}
          hosts:
            admin:
              host: keystone-api
            default: keystone
            internal: keystone-api
            public:
              host: keystone
              tls:
                ca: |
{{ spec.features.ssl.public_endpoints.ca_cert | indent( width=18, first=True) }}
{%- if rgw_internal_cacert is defined %}
{{ rgw_internal_cacert | indent( width=18, first=True) }}
{%- endif %}
                crt: |
{{ spec.features.ssl.public_endpoints.api_cert | indent( width=18, first=True) }}
                key: |
{{ spec.features.ssl.public_endpoints.api_key | indent( width=18, first=True) }}
          port:
            api:
              admin: 5000
              default: 80
              internal: 5000
              public: 443
          scheme:
            default: http
            public: https
        dashboard:
          host_fqdn_override:
            default: horizon.{{ spec.public_domain_name }}
            public:
              tls:
                ca: |
{{ spec.features.ssl.public_endpoints.ca_cert | indent( width=18, first=True) }}
                crt: |
{{ spec.features.ssl.public_endpoints.api_cert | indent( width=18, first=True) }}
                key: |
{{ spec.features.ssl.public_endpoints.api_key | indent( width=18, first=True) }}
          hosts:
            default: horizon-int
            public:
              host: horizon
              tls:
                ca: |
{{ spec.features.ssl.public_endpoints.ca_cert | indent( width=18, first=True) }}
                crt: |
{{ spec.features.ssl.public_endpoints.api_cert | indent( width=18, first=True) }}
                key: |
{{ spec.features.ssl.public_endpoints.api_key | indent( width=18, first=True) }}
          port:
            web:
              default: 80
              public: 443
          scheme:
            default: http
            public: https
      bootstrap:
        enabled: true
        script: |
          openstack network show heat-net || openstack network create heat-net
          openstack subnet show heat-subnet || openstack subnet create heat-subnet \
            --dhcp --subnet-range 10.20.30.0/24 \
            --allocation-pool start=10.20.30.10,end=10.20.30.254 \
            --gateway 10.20.30.1 \
            --network heat-net
          openstack router show heat-router || openstack router create heat-router
          subnet_id=$(openstack subnet show heat-subnet -f value -c id)
          if openstack router show heat-router -f json -c interfaces_info |grep -qw ${subnet_id}; then
            echo "$subnet_id is in the list"
          else
            openstack router add subnet heat-router heat-subnet
            openstack router set --external-gateway {{ spec.features.neutron.get('floating_network', {}).get('name', 'public') }} heat-router
          fi
{%- if spec.features.neutron.get('backend') != 'tungstenfabric' %}
          openstack subnet pool show default_pool || \
            openstack subnet pool create --share --default \
            --pool-prefix 10.20.40.0/24 --default-prefix-length 26 \
            default_pool
          openstack network auto allocated topology create --or-show
          openstack subnet pool set default_pool --default
{%- else %}
          openstack network show tempest-fixed-net || openstack network create tempest-fixed-net --share
          openstack subnet show tempest-subnet || openstack subnet create tempest-subnet \
            --dhcp --subnet-range 10.20.40.0/24 \
            --allocation-pool start=10.20.40.10,end=10.20.40.254 \
            --gateway 10.20.40.1 \
            --network tempest-fixed-net
{%- endif %}
      conf:
        static_accounts:
          project_count: 20
          project_count_with_network: 10
          project_count_without_network: 10
          {%- if spec.openstack_version not in ['queens', 'rocky', 'stein', 'train', 'ussuri', 'victoria', 'wallaby', 'xena'] %}
          create_reader_user: true
          {%- endif %}
          user_count: 5
        convert_to_uuid:
          identity:
{%- if signature.enabled %}
            default_domain_id: tempest
{%- else %}
            default_domain_id: Default
{%- endif %}
        tempest: {{ spec | generate_tempest_config(helmbundles_body) }}
