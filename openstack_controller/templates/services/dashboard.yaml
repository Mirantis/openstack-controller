#apiVersion: lcm.mirantis.com/v1alpha1
#kind: HelmBundle

{%- set keystone_keycloak_enabled = spec.get('features', {}).get('keystone', {}).get('keycloak', {}).get('enabled', False) %}
#The list of extra panels in Horizon helm-chart is overwritten in case 'extra_panels' is defined in openstack-controller.
{%- set horizon_extra_panels = ['neutron_taas_dashboard', 'heat_dashboard'] %}
{%- if 'load-balancer' in spec.features.services %}
  {%- do horizon_extra_panels.append('octavia_dashboard') %}
{%- endif %}
{%- if 'dns' in spec.features.services %}
  {%- do horizon_extra_panels.append('designatedashboard') %}
{%- endif %}

spec:
  releases:
  - name: openstack-horizon
    chart: {{spec.common.openstack.repo}}/horizon
    values:
      images:
        tags:
{%- for image in [
    "horizon_db_sync",
    "db_init",
    "db_drop",
    "horizon",
    "image_repo_sync",
    "test",
    "dep_check",] %}
        {%- if image in images %}
          {{ image }}: {{ images[image] }}
        {%- endif %}
{%- endfor %}
      dependencies:
        static:
          db_init:
            jobs:
              - openstack-mariadb-cluster-wait
      manifests:
        network_policy: false
        secret_ca_bundle: true
      endpoints:
        cluster_domain_suffix: {{ spec.internal_domain_name }}
{%- if keystone_keycloak_enabled %}
        identity:
          hosts:
            internal: keystone
          path:
            default: /v3
          port:
            api:
              internal: 80
{%- endif %}
        oslo_db:
          auth:
            admin:
              username: {{ admin_creds.database.username }}
              password: {{ admin_creds.database.password }}
            horizon:
              username: {{ credentials.database.user.username }}
              password: {{ credentials.database.user.password }}
        dashboard:
          host_fqdn_override:
            public:
              host: horizon.{{ spec.public_domain_name }}
              tls:
                ca: |
{{ spec.features.ssl.public_endpoints.ca_cert | indent( width=18, first=True) }}
                crt: |
{{ spec.features.ssl.public_endpoints.api_cert | indent( width=18, first=True) }}
                key: |
{{ spec.features.ssl.public_endpoints.api_key | indent( width=18, first=True) }}
          hosts:
            default: horizon-int
            public:
              host: horizon
              tls:
                ca: |
{{ spec.features.ssl.public_endpoints.ca_cert | indent( width=18, first=True) }}
                crt: |
{{ spec.features.ssl.public_endpoints.api_cert | indent( width=18, first=True) }}
                key: |
{{ spec.features.ssl.public_endpoints.api_key | indent( width=18, first=True) }}
      conf:
        horizon:
          extra_panels: {{ horizon_extra_panels }}
          local_settings:
            config:
              horizon_images_upload_mode: 'direct'
              secure_proxy_ssl_header: true
{%- if keystone_keycloak_enabled %}
              auth:
                idp_mapping:
                - idp: keycloak
                  label: External Authentication Service
                  name: mapped
                  protocol: mapped
                sso:
                  enabled: true
                  initial_choice: mapped
{%- endif %}
