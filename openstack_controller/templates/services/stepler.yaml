#apiVersion: lcm.mirantis.com/v1alpha1
#kind: HelmBundle

{%- set service = 'stepler' %}

spec:
  releases:
  - name: openstack-stepler
    chart: {{spec.common.openstack.repo}}/stepler
    values:
      images:
        tags:
{%- for image in [
    "stepler_run_tests",
    "ks_user",
    "dep_check",
    "bootstrap",] %}
        {%- if image in images %}
          {{ image }}: {{ images[image] }}
        {%- endif %}
{%- endfor %}
      manifests:
        network_policy: false
        secret_ca_bundle: true
      pvc:
        storage_class: {{ spec.get('persistent_volume_storage_class', 'kubernetes-hdd') }}
      endpoints:
        cluster_domain_suffix: {{ spec.internal_domain_name }}
{% include 'base/_admin_identity.yaml' %}
        dashboard:
          host_fqdn_override:
            public:
              tls:
                ca: |
{{ spec.features.ssl.public_endpoints.ca_cert | indent( width=18, first=True) }}
                crt: |
{{ spec.features.ssl.public_endpoints.api_cert | indent( width=18, first=True) }}
                key: |
{{ spec.features.ssl.public_endpoints.api_key | indent( width=18, first=True) }}
          hosts:
            default: horizon-int
            public:
              host: horizon
              tls:
                ca: |
{{ spec.features.ssl.public_endpoints.ca_cert | indent( width=18, first=True) }}
                crt: |
{{ spec.features.ssl.public_endpoints.api_cert | indent( width=18, first=True) }}
                key: |
{{ spec.features.ssl.public_endpoints.api_key | indent( width=18, first=True) }}
          port:
            web:
              default: 80
              public: 443
          scheme:
            default: http
            public: https
      conf:
        skiplist: |
{% include 'base/_stepler_skiplist.yaml' %}
      bootstrap:
        enabled: false
