#apiVersion: lcm.mirantis.com/v1alpha1
#kind: HelmBundle

{%- set stacklight_enabled = spec.get('features', {}).get('stacklight', {}).get('enabled', False) %}

spec:
  available_releases:
    - "openstack-memcached"
  releases:
  - name: openstack-memcached
    chart: {{spec.common.infra.repo}}/memcached
    values:
      images:
        tags:
{%- for image in [
    "dep_check",
    "memcached",
    "prometheus_memcached_exporter",
    "image_repo_sync",] %}
        {%- if image in images %}
          {{ image }}: {{ images[image] }}
        {%- endif %}
{%- endfor %}
  {%- if stacklight_enabled %}
      monitoring:
        prometheus:
          enabled: true
  {%- endif %}
      manifests:
        network_policy: false
        statefulset: true
        deployment: false
      endpoints:
        cluster_domain_suffix: {{ spec.internal_domain_name }}
      pod:
        replicas:
          server: 3
      scripts:
        prometheus_memcached_exporter: |
          #!/bin/bash
          set -ex
          COMMAND="${@:-start}"

          function start () {
            memcached_exporter --memcached.address "$MEMCACHED_HOST:$MEMCACHED_PORT"
          }

          function stop () {
            kill -TERM 1
          }

          $COMMAND

